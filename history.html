<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="styles.css">
	<title>History</title>
	<style>
		@media (max-width: 576px) {
		    .container-c {
		        flex-direction: column;
		        padding: 10px;
		        height: auto;
		    }

		    .sidebar {
		        width: 100%;
		        height: auto;
		        padding: 15px;
		    }

		    .side-logo img {
		        width: 100px;
		        height: auto;
		        margin-bottom: 10px;
		    }

		    .side-nav a {
		        font-size: 24px;
		        padding: 10px 0;
		        display: block;
		        text-align: center;
		        width: 100%;
		    }

		    .calculator {
		        width: 100%;
		        padding: 10px;
		        text-align: center;
		    }

		    .title h1 {
		        font-size: 26px;
		        line-height: 32px;
		    }

		    .title h2 {
		        font-size: 20px;
		    }

		    .table {
		        width: 100%;
		        overflow-x: auto;
		        padding: 10px 0;
		    }

		    table {
		        width: 100% !important;
		        font-size: 14px;
		        border-collapse: collapse;
		    }

		    table th,
		    table td {
		        padding: 8px;
		        text-align: center;
		        font-size: 14px;
		    }

		    .delete-btn {
		        padding: 5px 10px;
		        border-radius: 5px;
		        background-color: #ff4d4f;
		        color: white;
		        border: none;
		        cursor: pointer;
		    }
		}
	</style>
</head>
<body style="background-color: #C8EDE6;">
	<div class="container-c">
		<div class="sidebar">
			<div class="side-logo">
				<img src="images/logo.png">
			</div>
			<div class="side-nav">
				<a href="dashboard.html">DASHBOARD</a>
				<a href="profile.html">PROFILE</a>
				<a href="calculator.html">CALCULATOR</a>
				<a style="background-color: #C8EDE6;" href="history.html">HISTORY</a>
			</div>
		</div>

		<div class="calculator">
			<div class="title">
				<h1>ELECTRIC BILL <br>CALCULATOR</h1>
				<h2>HISTORY</h2>
			</div>

			<div class="table">
				<table id="historyTable">
					<tr>
						<th>DATE</th>
						<th>POWER CONSUMPTION</th>
						<th>COST PER KWH</th>
						<th>BILL</th>
						<th>ACTION</th>
					</tr>
				</table>
			</div>
		</div>
	</div>

	<!-- Supabase -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	<script src="supabase-config.js"></script>
	<script>
		async function loadHistory() {
			const { data: { session } } = await supabaseClient.auth.getSession();
			const user = session?.user;

			if (!user) {
				alert("Please login first!");
				window.location.href = "login.html";
				return;
			}

			const { data, error } = await supabaseClient
				.from("calculations")
				.select("*")
				.eq("user_id", user.id)
				.order("date", { ascending: false });

			if (error) {
				console.error(error);
				alert("Failed to fetch history!");
				return;
			}

			const table = document.getElementById("historyTable");
			table.querySelectorAll("tr:not(:first-child)").forEach(row => row.remove());

			data.forEach(calc => {
				const row = table.insertRow();
				row.insertCell(0).textContent = new Date(calc.date).toLocaleString();
				row.insertCell(1).textContent = calc.power_consumption;
				row.insertCell(2).textContent = calc.cost_per_kwh;
				row.insertCell(3).textContent = calc.result;

				// Add delete button
				const actionCell = row.insertCell(4);
				const deleteBtn = document.createElement("button");
				deleteBtn.textContent = "Delete";
				deleteBtn.className = "delete-btn";
				deleteBtn.onclick = async () => {
					const confirmDelete = confirm("Are you sure you want to delete this record?");
					if (!confirmDelete) return;

					const { error } = await supabaseClient
						.from("calculations")
						.delete()
						.eq("id", calc.id);

					if (error) {
						alert("Failed to delete record!");
						console.error(error);
					} else {
						row.remove(); // Remove row from table
					}
				};
				actionCell.appendChild(deleteBtn);
			});
		}

		document.addEventListener("DOMContentLoaded", loadHistory);
	</script>
</body>
</html>
